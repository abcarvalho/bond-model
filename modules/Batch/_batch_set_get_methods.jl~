
# function set_dir_obj(btc, main_dir, res_dir, mat_dir_prefix, coupon_dir_prefix=nothing)
#     batch["dir"] = Dict()
#     batch["dir"]["main"] = main_dir
#     batch["dir"]["res"] = string(res_dir, 
#                                  "CVM"^Int(occursin(btc["name"], "CVM")), 
#                                  "SVM"^Int(occursin(btc["name"], "SVM")))
#     batch["dir"]["mat_prefix"] = mat_dir_prefix

#     if !(coupon_dir_prefix==nothing)
#         batch["dir"]["coupon_prefix"] = coupon_dir_prefix
#     end
# end


# ############## Set Parameter Combinations ##############
function svm_set_params_combs(bt)
    bt._params_combs = [Array([x1, x2, x3, x4, x5, x6, x7, x8, x9]) 
                       for x1 in bt.svm_param_values_dict[bt._params_order[1]], 
                           x2 in bt.svm_param_values_dict[bt._params_order[2]],
                           x3 in bt.svm_param_values_dict[bt._params_order[3]],
                           x4 in bt.svm_param_values_dict[bt._params_order[4]],
                           x5 in bt.svm_param_values_dict[bt._params_order[5]],
                           x6 in bt.svm_param_values_dict[bt._params_order[6]],
                           x7 in bt.svm_param_values_dict[bt._params_order[7]],
                           x8 in bt.svm_param_values_dict[bt._params_order[8]], 
                           x9 in bt.svm_param_values_dict[bt._params_order[9]]]

    return bt
end

# ########################################################

# ############## Store Parameters ##############
function set_par_dict(bt, comb_num)
    bt.mi._svm_dict = Dict()
    for par in bt._params_order
        bt.mi._svm_dict[par] = bt._params_combs[comb_num][findall(x-> x==par, bt._params_order)[1]]
    end
    
    bt.mi._svm_dict = merge(bt._common_params, bt.mi._svm_dict)
    
    return bt
end


function get_par_dict(bt)
    return bt.mi._svm_dict
end

# ############## Set Directories ##############
function form_main_dir_path(main_dir::String)
    return joinpath(pwd()[1:findfirst("artur", pwd())[end]],
                    "BondPricing", main_dir)
end

function set_main_dir_path(bt)
    # Main directory is called "Julia". Find it!
    # bt.mi.main_dir_path = joinpath(pwd()[1:findfirst("artur", pwd())[end]],
    #                                "BondPricing", bt.dfn.main_dir)
    bt.mi.main_dir_path = form_main_dir_path(bt.dfn.main_dir)
    return bt
end

function set_batch_res_dir(bt)
    # Path to the Results Directory
    if abs(bt.mi._svm_dict["sigmah"] - bt.mi._svm_dict["sigmal"]) < 1e-4
        bt.mi.batch_res_dir = string(bt.dfn.res_dir, "Tests")
    else
        bt.mi.batch_res_dir = bt.dfn.res_dir
    end

    return bt
end


function set_maturity_dir(bt)
    bt.mi.maturity_dir = string(bt.dfn.mat_dir_prefix, 
                                 get_par_dict(bt)["m"])
    return bt
end


function set_comb_res_dir(bt)
    folder_name = string("xi_", @sprintf("%.2f", get_par_dict(bt)["xi"]),
                         "__kappa_", @sprintf("%.0f", 1e4 * get_par_dict(bt)["kappa"]),
                         "_bp", 
                         "__gross_delta_", @sprintf("%.0f", 1e4 * get_par_dict(bt)["gross_delta"]),
                         "_bp",                      
                         "__iota_", @sprintf("%.0f", 1e4 * get_par_dict(bt)["iota"]), 
                         "_bp")
    
    if "sigma" in bt._params_order
        bt.mi.comb_res_dir = string(folder_name, "__sigma_", 
                                     @sprintf("%.2f", get_par_dict(bt)["sigma"]))
    else
        bt.mi.comb_res_dir = string(folder_name, 
                                     "__lambda_", @sprintf("%.2f", get_par_dict(bt)["lambda"]),
                                     "__sigmal_", @sprintf("%.2f", get_par_dict(bt)["sigmal"]),
                                     "__sigmah_", @sprintf("%.2f", get_par_dict(bt)["sigmah"]))
    end
    
    return bt
end


# ############## Get Directories ##############
function get_batch_res_dir(bt)
    return bt.mi.batch_res_dir
end
    
function get_maturity_dir(bt)
    return bt.mi.maturity_dir
end
    
function get_comb_res_dir(bt)
    return bt.mi.comb_res_dir
end

# ############## Set Paths ##############
function get_main_dir_path(bt)
    return bt.mi.main_dir_path
end


function set_comb_res_paths(bt)
    
    # Path to Main Directory
    bt = set_main_dir_path(bt)

    # Generate Folder Names:
    bt = set_batch_res_dir(bt)
    bt = set_maturity_dir(bt)
    bt = set_comb_res_dir(bt)

    # ############ Set Paths ###########
    # Main Results 
    bt.mi.batch_res_path = joinpath(get_main_dir_path(bt), get_batch_res_dir(bt))

    # Maturity
    bt.mi.maturity_path = joinpath(bt.mi.batch_res_path, get_maturity_dir(bt))

    # Parameter Combination 
    bt.mi.comb_res_path = joinpath(bt.mi.maturity_path, get_comb_res_dir(bt))
    
    return bt
end


function get_coupon_res_path(bt, coupon)
    bt = set_comb_res_paths(bt)
    
    return joinpath(bt.mi.comb_res_path, 
                    string(bt.coupon_dir_prefix, @sprintf("%.2f", coupon)))    
end



# ############## Create Directories ##############
function mk_comb_res_dirs(bt)
    # Generate Paths
    bt = set_comb_res_paths(bt)

    # Main Results
    if occursin("Tests", bt.mi.batch_res_path)
        pos = findfirst("Tests", bt.mi.batch_res_path)[1] - 1
        path = bt.mi.batch_res_path[1:pos]
        if !isdir(path)
            mkdir(path)
        end
    end
    if !isdir(bt.mi.batch_res_path)
        mkdir(bt.mi.batch_res_path)
    end
        
    # Maturity
    if !isdir(bt.mi.maturity_path)
        mkdir(bt.mi.maturity_path)
    end

    # Parameter Combination 
    if !isdir(bt.mi.comb_res_path)
        mkdir(bt.mi.comb_res_path)
    end

    return bt
end

function mk_coupon_dir(bt, coupon)
    mk_comb_res_dirs(bt)
    coupon_res_dir = get_coupon_res_path(bt, coupon)
    
    # Create coupon sub-folder:
    if !isdir(coupon_res_dir)
        mkdir(coupon_res_dir)
    end

    return coupon_res_dir
end


# ############## Get Directories ##############
function get_results_path(bt, m)
    set_main_dir_path(bt)
    if bt.mi._svm_dict == nothing
        bt.mi.batch_res_dir = bt.dfn.res_dir    
    else
        set_batch_res_dir(bt)
    end

    return string(bt.mi.main_dir_path, "/", 
                  bt.mi.batch_res_dir, 
                  string(bt.dfn.mat_dir_prefix, @sprintf("%.1f", m)))
end


# ############## Get Batch & SVM Objects ##############
function get_bt(comb_num::Integer; bt=nothing)
    # Create Model Object'
    if bt==nothing
        bt = BatchObj()
    end
    
    # Set Combination
    bt = set_par_dict(bt, comb_num)
    
    # Set Directories & Paths (Main, Batch, Maturity, Combination)
    bt = set_comb_res_paths(bt)

    # Set Directories & Paths (Main, Batch, Maturity, Combination)
    bt = set_comb_res_paths(bt)

    return bt
end


function get_bt_svm(comb_num::Integer; bt=nothing, compute_surfs::Bool=false)
    bt = get_bt(comb_num; bt=bt)
    
    local batch_obj_exists = false
    try
        batch_obj_exists = check_batch_results(bt)
    catch
        println("Unable to load Batch object file. Recomputing... ")
    end
    
    println(string("Batch object exists: ", batch_obj_exists))

    # Check if results exist
    if batch_obj_exists
        # Load SVM object
        println("Loading SVM object...")
        svm = load_batch_results(bt)["svm"]

        # Check if Bond Pricing Surfaces exist
        surfs_exist = check_bpr_surfaces(svm)
    else
        # Create SVM object
        svm = firm_constructor(bt.mi._svm_dict)
        surfs_exist = false
    end

    if !surfs_exist | compute_surfs
        # Compute Bond Price Inputs
        svm = @time bpr_surfs(svm)
    end

    # Interpolate Bond Pricing Surfaces
    println("Interpolating bond pricing surfaces...")
    svm = @time bpr_interp(svm)
    
    return bt, svm
end
